# tests/test_core_additions.py
from io import StringIO

import pandas as pd
from pandas.testing import assert_frame_equal
import pytest

import mozaic
from mozaic.core import Mozaic
from mozaic.tile import sum_tile_dfs


# Helper functions

def assert_columns_match(df: pd.DataFrame, cols: list[str]) -> None:
    assert list(df.columns) == cols, f"Expected columns {cols}, got {list(df.columns)}"

def assert_dataframes_equal(df_actual: pd.DataFrame, df_expected: pd.DataFrame, rtol: float = 1e-6, atol: float = 1e-12):
    assert_frame_equal(df_actual, df_expected, check_exact=False, rtol=rtol, atol=atol)



# cur_mozaic fixture is defined in conftest.py (session-scoped).


# Tests and Golden Data

## get_countries

G_COUNTRIES_EXPECTED = {'US', 'JP'}
def test_get_countries(cur_mozaic: Mozaic):
    assert_columns_matchactual = cur_mozaic.get_countries()
    assert isinstance(assert_columns_matchactual, set)
    assert assert_columns_matchactual == G_COUNTRIES_EXPECTED


## get_populations

G_POPULATIONS_EXPECTED = {"win10", "win11", "winX", "other"}
def test_get_populations(cur_mozaic: Mozaic):
    assert_columns_matchactual = cur_mozaic.get_populations()
    assert isinstance(assert_columns_matchactual, set)
    assert assert_columns_matchactual == G_POPULATIONS_EXPECTED

## _standard_df_to_forecast_df
STANDARD_DF = """submission_date,actuals,actuals_detrended,forecast_detrended_raw,forecast_raw,forecast_detrended,forecast,forecast_detrended_raw_28ma,forecast_raw_28ma,forecast_detrended_28ma,forecast_28ma,actuals_28ma,actuals_detrended_28ma
2025-10-22,9090077.0,9090077.0,,,,,,,,,,
2025-10-23,8989171.0,8989171.0,,,,,,,,,,
2025-10-24,8667775.0,8667775.0,,,,,,,,,,
2025-10-25,6873198.0,6873198.0,,,,,,,,,,
2025-10-26,6496392.0,6496392.0,,,,,,,,,,
2025-10-27,8553234.0,8917406.666666666,,,,,,,,,,
2025-10-28,9182515.0,9182515.0,,,,,,,,,8330403.964285715,8343410.130952381
2025-10-29,9357579.0,9357579.0,,,,,,,,,8317969.571428572,8330975.738095238
2025-10-30,9306516.0,9306516.0,,,,,,,,,8310869.035714285,8323875.202380952
2025-10-31,9032531.0,9032531.0,,,,,,,,,8305355.892857143,8318362.059523809
2025-11-01,7218134.0,7218134.0,8346197.427962832,8346197.427962832,8346197.427962832,8346197.427962832,8359327.431951053,8346321.265284387,8359327.431951053,8346321.265284387,8306033.285714285,8319039.452380952
2025-11-02,6678248.0,6728640.0,8255022.004508676,8255022.004508676,8255022.004508676,8255022.004508676,8418268.57496922,8405262.408302555,8418268.57496922,8405262.408302555,8308661.071428572,8323466.952380952
2025-11-03,8607347.0,9282677.642857142,8417092.960344236,8417092.960344236,8417092.960344236,8417092.960344236,8412681.9306958,8399675.764029134,8412681.9306958,8399675.764029134,8309869.214285715,8348794.046768708
2025-11-04,9516610.0,9516610.0,8317474.317058213,8317474.317058213,8317474.317058213,8317474.317058213,8383112.227733594,8370106.061066926,8383112.227733594,8370106.061066926,8323125.785714285,8362050.618197279
2025-11-05,9498953.0,9498953.0,8425347.452268165,8425347.452268165,8425347.452268165,8425347.452268165,8357513.815314599,8344507.648647933,8357513.815314599,8344507.648647933,8335870.428571428,8374795.261054422
2025-11-06,9448413.0,9448413.0,8352478.01883121,8352478.01883121,8352478.01883121,8352478.01883121,8332237.494558572,8319231.327891904,8332237.494558572,8319231.327891904,8349734.642857143,8388659.475340137
2025-11-07,9220234.0,9232493.635818409,8366642.7002262175,8366642.7002262175,8366642.7002262175,8366642.7002262175,8320299.0195666505,8307292.8528999835,8320299.0195666505,8307292.8528999835,8368281.571428572,8407644.248047937
2025-11-08,7498446.0,7498446.0,8290236.79824556,8290236.79824556,8290236.79824556,8290236.79824556,8370774.262361134,8357768.095694468,8370774.262361134,8357768.095694468,8390478.57142857,8429841.248047937
2025-11-09,6766558.0,7001652.991561056,8353838.442972459,8353838.442972459,8353838.442972459,8353838.442972459,8441560.456753008,8428554.290086342,8441560.456753008,8428554.290086342,8404576.17857143,8452335.104889402
2025-11-10,8839632.0,9651028.5,8375408.218277939,8375408.218277939,8375408.218277939,8375408.218277939,8450917.821691507,8437911.65502484,8450917.821691507,8437911.65502484,8430512.964285715,8507250.33703226
2025-11-11,9323335.0,9596438.5,8366925.235651627,8366925.235651627,8366925.235651627,8366925.235651627,8424639.258679064,8411633.092012398,8424639.258679064,8411633.092012398,8438391.892857144,8524882.96203226
2025-11-12,9516933.0,9516933.0,8344328.569443791,8344328.569443791,8344328.569443791,8344328.569443791,8392254.350444915,8379248.183778248,8392254.350444915,8379248.183778248,8447885.714285715,8534376.783460831
2025-11-13,9605494.0,9605494.0,8345442.327552639,8345442.327552639,8345442.327552639,8345442.327552639,8364961.2192860795,8351955.052619413,8364961.2192860795,8351955.052619413,8465594.42857143,8552085.497746546
2025-11-14,9340130.0,9340130.0,8377641.605714135,8377641.605714135,8377641.605714135,8377641.605714135,8353345.455204442,8340339.288537775,8353345.455204442,8340339.288537775,8488353.25,8574844.319175117
2025-11-15,7567276.0,7567276.0,8420604.643715277,8420604.643715277,8420604.643715277,8420604.643715277,8410459.656765701,8397453.490099035,8410459.656765701,8397453.490099035,8514991.42857143,8601482.497746546
2025-11-16,6957008.0,7111183.166666667,8272180.515012936,8272180.515012936,8272180.515012936,8272180.515012936,8473849.92515902,8460843.758492354,8473849.92515902,8460843.758492354,8531411.25,8623408.575127497
2025-11-17,,,8377332.55601136,8377332.55601136,8377332.55601136,8377332.55601136,8465599.587873712,8452593.421207046,8465599.587873712,8452593.421207046,,
2025-11-18,,,8298595.346459734,8298595.346459734,8298595.346459734,8298595.346459734,8436283.921675846,8423277.755009178,8436283.921675846,8423277.755009178,,
2025-11-19,,,8371491.982679932,8371491.982679932,8371491.982679932,8371491.982679932,8410620.17105727,8397614.004390605,8410620.17105727,8397614.004390605,,
2025-11-20,,,8366435.479611335,8366435.479611335,8366435.479611335,8366435.479611335,8388379.616757676,8375373.45009101,8388379.616757676,8375373.45009101,,
2025-11-21,,,8360859.359679623,8360859.359679623,8360859.359679623,8360859.359679623,8377418.343889092,8364412.177222425,8377418.343889092,8364412.177222425,,
2025-11-22,,,8237761.4012929555,8237761.4012929555,8237761.4012929555,8237761.4012929555,8426152.751078125,8413146.584411459,8426152.751078125,8413146.584411459,,
2025-11-23,,,8222853.781673966,8222853.781673966,8222853.781673966,8222853.781673966,8487812.100423625,8474805.933756959,8487812.100423625,8474805.933756959,,
2025-11-24,,,8298556.728501512,8298556.728501512,8298556.728501512,8298556.728501512,8465710.316917727,8465710.316917727,8465710.316917727,8465710.316917727,,
2025-11-25,,,8290655.984896515,8290655.984896515,8290655.984896515,8290655.984896515,8433858.20923546,8433858.209235458,8433858.20923546,8433858.209235458,,
2025-11-26,,,8367874.826423585,8367874.826423585,8367874.826423585,8367874.826423585,8398511.63160773,8398511.63160773,8398511.63160773,8398511.63160773,,"""

G_FORECAST_TRANSLATION_DF = """target_date,source,value
2025-10-22,actual,9090077.0
2025-10-23,actual,8989171.0
2025-10-24,actual,8667775.0
2025-10-25,actual,6873198.0
2025-10-26,actual,6496392.0
2025-10-27,actual,8553234.0
2025-10-28,actual,9182515.0
2025-10-29,actual,9357579.0
2025-10-30,actual,9306516.0
2025-10-31,actual,9032531.0
2025-11-01,forecast,8346197.427962832
2025-11-02,forecast,8255022.004508676
2025-11-03,forecast,8417092.960344236
2025-11-04,forecast,8317474.317058213
2025-11-05,forecast,8425347.452268165
2025-11-06,forecast,8352478.01883121
2025-11-07,forecast,8366642.7002262175
2025-11-08,forecast,8290236.79824556
2025-11-09,forecast,8353838.442972459
2025-11-10,forecast,8375408.218277939
2025-11-11,forecast,8366925.235651627
2025-11-12,forecast,8344328.569443791
2025-11-13,forecast,8345442.327552639
2025-11-14,forecast,8377641.605714135
2025-11-15,forecast,8420604.643715277
2025-11-16,forecast,8272180.515012936
2025-11-17,forecast,8377332.55601136
2025-11-18,forecast,8298595.346459734
2025-11-19,forecast,8371491.982679932
2025-11-20,forecast,8366435.479611335
2025-11-21,forecast,8360859.359679623
2025-11-22,forecast,8237761.4012929555
2025-11-23,forecast,8222853.781673966
2025-11-24,forecast,8298556.728501512
2025-11-25,forecast,8290655.984896515
2025-11-26,forecast,8367874.826423585"""
def test__standard_df_to_forecast_df():
    standard_df = pd.read_csv(StringIO(STANDARD_DF))
    out = Mozaic._standard_df_to_forecast_df(standard_df, ma=False)

    assert_columns_match(out, ["target_date", "source", "value"])
    assert_dataframes_equal(
        out,
        pd.read_csv(StringIO(G_FORECAST_TRANSLATION_DF)),
    )


G_FORECAST_TRANSLATION_DF_MA = """target_date,source,value
2025-10-28,actual,8330403.964285715
2025-10-29,actual,8317969.571428572
2025-10-30,actual,8310869.035714285
2025-10-31,actual,8305355.892857143
2025-11-01,forecast,8346321.265284387
2025-11-02,forecast,8405262.408302555
2025-11-03,forecast,8399675.764029134
2025-11-04,forecast,8370106.061066926
2025-11-05,forecast,8344507.648647933
2025-11-06,forecast,8319231.327891904
2025-11-07,forecast,8307292.8528999835
2025-11-08,forecast,8357768.095694468
2025-11-09,forecast,8428554.290086342
2025-11-10,forecast,8437911.65502484
2025-11-11,forecast,8411633.092012398
2025-11-12,forecast,8379248.183778248
2025-11-13,forecast,8351955.052619413
2025-11-14,forecast,8340339.288537775
2025-11-15,forecast,8397453.490099035
2025-11-16,forecast,8460843.758492354
2025-11-17,forecast,8452593.421207046
2025-11-18,forecast,8423277.755009178
2025-11-19,forecast,8397614.004390605
2025-11-20,forecast,8375373.45009101
2025-11-21,forecast,8364412.177222425
2025-11-22,forecast,8413146.584411459
2025-11-23,forecast,8474805.933756959
2025-11-24,forecast,8465710.316917727
2025-11-25,forecast,8433858.209235458
2025-11-26,forecast,8398511.63160773"""
def test__standard_df_to_forecast_df_ma():
    standard_df = pd.read_csv(StringIO(STANDARD_DF))
    out = Mozaic._standard_df_to_forecast_df(standard_df, ma=True)

    assert_columns_match(out, ["target_date", "source", "value"])
    assert_dataframes_equal(
        out,
        pd.read_csv(StringIO(G_FORECAST_TRANSLATION_DF_MA)),
    )


## to_forecast_df

G_FORECAST_DATA_DF = {
    (None, None, False, 0.5): """target_date,source,value
2025-10-01,actual,9705742.0
2025-10-02,actual,9505331.0
2025-10-03,actual,9186899.0
2025-10-04,actual,7199167.0
2025-10-05,actual,6604670.0
2025-10-06,actual,8573519.0
2025-10-07,actual,9145426.0
2025-10-08,actual,9142103.0
2025-10-09,actual,9060215.0
2025-10-10,actual,8700920.0
2025-10-11,actual,6876930.0
2025-10-12,actual,6371825.0
2025-10-13,actual,8113402.0
2025-10-14,actual,9102725.0
2025-10-15,actual,9251106.0
2025-10-16,actual,9109650.0
2025-10-17,actual,8702883.0
2025-10-18,actual,6821407.0
2025-10-19,actual,6497253.0
2025-10-20,actual,8608342.0
2025-10-21,actual,9119434.0
2025-10-22,actual,9090077.0
2025-10-23,actual,8989171.0
2025-10-24,actual,8667775.0
2025-10-25,actual,6873198.0
2025-10-26,actual,6496392.0
2025-10-27,actual,8553234.0
2025-10-28,actual,9182515.0
2025-10-29,actual,9357579.0
2025-10-30,actual,9306516.0
2025-10-31,actual,9032531.0
2025-11-01,forecast,8346197.427962832
2025-11-02,forecast,8255022.004508676
2025-11-03,forecast,8417092.960344236
2025-11-04,forecast,8317474.317058213
2025-11-05,forecast,8425347.452268165
2025-11-06,forecast,8352478.01883121
2025-11-07,forecast,8366642.7002262175
2025-11-08,forecast,8290236.79824556
2025-11-09,forecast,8353838.442972459
2025-11-10,forecast,8375408.218277939
2025-11-11,forecast,8366925.235651627
2025-11-12,forecast,8344328.569443791
2025-11-13,forecast,8345442.327552639
2025-11-14,forecast,8377641.605714135
2025-11-15,forecast,8420604.643715277
2025-11-16,forecast,8272180.515012936
2025-11-17,forecast,8377332.55601136
2025-11-18,forecast,8298595.346459734
2025-11-19,forecast,8371491.982679932
2025-11-20,forecast,8366435.479611335
2025-11-21,forecast,8360859.359679623
2025-11-22,forecast,8237761.4012929555
2025-11-23,forecast,8222853.781673966
2025-11-24,forecast,8298556.728501512
2025-11-25,forecast,8290655.984896515
2025-11-26,forecast,8367874.826423585
2025-11-27,forecast,8351050.430786505
2025-11-28,forecast,8284799.495423452
2025-11-29,forecast,8309048.891311852
2025-11-30,forecast,8158761.1803109385
2025-12-01,forecast,8316150.046893602
2025-12-02,forecast,8359967.414431406
2025-12-03,forecast,8339507.663219359
2025-12-04,forecast,8363753.248556917
2025-12-05,forecast,8378182.068933206
2025-12-06,forecast,8239032.766845984
2025-12-07,forecast,8269586.444587616
2025-12-08,forecast,8315034.464593668
2025-12-09,forecast,8249474.85583197
2025-12-10,forecast,8307719.282493873
2025-12-11,forecast,8297396.16353936
2025-12-12,forecast,8321110.390783726
2025-12-13,forecast,8299680.328711521
2025-12-14,forecast,8168032.709190464
2025-12-15,forecast,8280865.989605613
2025-12-16,forecast,8272486.09427073
2025-12-17,forecast,8258836.679513762
2025-12-18,forecast,8231984.2256974615
2025-12-19,forecast,8183657.860484047
2025-12-20,forecast,8179301.087717933
2025-12-21,forecast,8155187.055194645
2025-12-22,forecast,8281941.68174358
2025-12-23,forecast,8288481.553602744
2025-12-24,forecast,8302527.728560831
2025-12-25,forecast,8236714.731416743
2025-12-26,forecast,8279610.978001854
2025-12-27,forecast,8162214.848883914
2025-12-28,forecast,8199446.052494897
2025-12-29,forecast,8186590.690295996
2025-12-30,forecast,8192380.943150809
2025-12-31,forecast,8284554.373097556
2026-01-01,forecast,8250109.124906215""",
    ("US", None, False, 0.5): """target_date,source,value
2025-10-01,actual,8439076.0
2025-10-02,actual,8242274.0
2025-10-03,actual,7958531.0
2025-10-04,actual,6292697.0
2025-10-05,actual,5666829.0
2025-10-06,actual,7365575.0
2025-10-07,actual,7942620.0
2025-10-08,actual,7942891.0
2025-10-09,actual,7845186.0
2025-10-10,actual,7541691.0
2025-10-11,actual,5993430.0
2025-10-12,actual,5529154.0
2025-10-13,actual,7105353.0
2025-10-14,actual,7881720.0
2025-10-15,actual,8022619.0
2025-10-16,actual,7889318.0
2025-10-17,actual,7537276.0
2025-10-18,actual,5933790.0
2025-10-19,actual,5532837.0
2025-10-20,actual,7400732.0
2025-10-21,actual,7907130.0
2025-10-22,actual,7891699.0
2025-10-23,actual,7791932.0
2025-10-24,actual,7517741.0
2025-10-25,actual,5990940.0
2025-10-26,actual,5532270.0
2025-10-27,actual,7355484.0
2025-10-28,actual,7976222.0
2025-10-29,actual,8139475.0
2025-10-30,actual,8071677.0
2025-10-31,actual,7813828.0
2025-11-01,forecast,7208235.311826322
2025-11-02,forecast,7124790.6868590815
2025-11-03,forecast,7265048.0768073555
2025-11-04,forecast,7177268.621183773
2025-11-05,forecast,7269923.493820902
2025-11-06,forecast,7204097.599341764
2025-11-07,forecast,7215211.998994195
2025-11-08,forecast,7148933.737281875
2025-11-09,forecast,7201094.7746301545
2025-11-10,forecast,7218617.977563735
2025-11-11,forecast,7209429.557252519
2025-11-12,forecast,7188015.8144085305
2025-11-13,forecast,7187298.454983761
2025-11-14,forecast,7213563.744440116
2025-11-15,forecast,7252224.066487043
2025-11-16,forecast,7117928.436620433
2025-11-17,forecast,7208788.723091796
2025-11-18,forecast,7138674.996704638
2025-11-19,forecast,7200768.670008154
2025-11-20,forecast,7193956.59795019
2025-11-21,forecast,7187846.98669145
2025-11-22,forecast,7080329.054807807
2025-11-23,forecast,7063646.330363725
2025-11-24,forecast,7128147.645276026
2025-11-25,forecast,7119981.883208724
2025-11-26,forecast,7186627.5215778425
2025-11-27,forecast,7169226.218446656
2025-11-28,forecast,7109210.822954157
2025-11-29,forecast,7131172.462685663
2025-11-30,forecast,6995266.649612612
2025-12-01,forecast,7131994.914459288
2025-12-02,forecast,7169292.334803111
2025-12-03,forecast,7149847.498902174
2025-12-04,forecast,7168568.730921729
2025-12-05,forecast,7179635.302246487
2025-12-06,forecast,7057943.006976604
2025-12-07,forecast,7081198.203010409
2025-12-08,forecast,7119706.108368392
2025-12-09,forecast,7060348.640837869
2025-12-10,forecast,7110187.227868625
2025-12-11,forecast,7098823.948041078
2025-12-12,forecast,7118383.653249662
2025-12-13,forecast,7099855.089562667
2025-12-14,forecast,6980498.990528991
2025-12-15,forecast,7077947.808825066
2025-12-16,forecast,7068623.729706688
2025-12-17,forecast,7055073.169106389
2025-12-18,forecast,7029950.456680895
2025-12-19,forecast,6986562.485090469
2025-12-20,forecast,6983169.7387410365
2025-12-21,forecast,6957820.999026958
2025-12-22,forecast,7067736.029346355
2025-12-23,forecast,7071626.271586338
2025-12-24,forecast,7082973.94986801
2025-12-25,forecast,7023247.1686730515
2025-12-26,forecast,7059755.75248132
2025-12-27,forecast,6956766.8616393
2025-12-28,forecast,6985913.429661291
2025-12-29,forecast,6973176.745282279
2025-12-30,forecast,6977467.856580455
2025-12-31,forecast,7056606.166998147
2026-01-01,forecast,7023569.5419397885""",
    (None, "win10", False, 0.5): """target_date,source,value
2025-10-01,actual,2503217.0
2025-10-02,actual,2444896.0
2025-10-03,actual,2360118.0
2025-10-04,actual,1877109.0
2025-10-05,actual,1721731.0
2025-10-06,actual,2191591.0
2025-10-07,actual,2329741.0
2025-10-08,actual,2331498.0
2025-10-09,actual,2305706.0
2025-10-10,actual,2221868.0
2025-10-11,actual,1808849.0
2025-10-12,actual,1672653.0
2025-10-13,actual,2093228.0
2025-10-14,actual,2281251.0
2025-10-15,actual,2301659.0
2025-10-16,actual,2240785.0
2025-10-17,actual,2140001.0
2025-10-18,actual,1736587.0
2025-10-19,actual,1637375.0
2025-10-20,actual,2104244.0
2025-10-21,actual,2206651.0
2025-10-22,actual,2195112.0
2025-10-23,actual,2158906.0
2025-10-24,actual,2086758.0
2025-10-25,actual,1713163.0
2025-10-26,actual,1608972.0
2025-10-27,actual,2055384.0
2025-10-28,actual,2178172.0
2025-10-29,actual,2192088.0
2025-10-30,actual,2171560.0
2025-10-31,actual,2101915.0
2025-11-01,forecast,1982590.1661243483
2025-11-02,forecast,1956602.555923392
2025-11-03,forecast,1988843.8857185612
2025-11-04,forecast,1961666.2166223018
2025-11-05,forecast,1980195.8742709055
2025-11-06,forecast,1958373.370457773
2025-11-07,forecast,1954693.920590858
2025-11-08,forecast,1928994.8882795414
2025-11-09,forecast,1936078.3111559178
2025-11-10,forecast,1938025.2863613828
2025-11-11,forecast,1932303.9270038889
2025-11-12,forecast,1922586.8404811723
2025-11-13,forecast,1916409.3714677969
2025-11-14,forecast,1917485.4802999015
2025-11-15,forecast,1917278.9224197802
2025-11-16,forecast,1879697.2191043645
2025-11-17,forecast,1899816.6222156351
2025-11-18,forecast,1878558.6879017435
2025-11-19,forecast,1889576.860392768
2025-11-20,forecast,1882886.8829982772
2025-11-21,forecast,1875522.1853309404
2025-11-22,forecast,1840563.5131361138
2025-11-23,forecast,1831252.9140292173
2025-11-24,forecast,1845790.866123303
2025-11-25,forecast,1840075.7279975456
2025-11-26,forecast,1851970.3403135003
2025-11-27,forecast,1843079.406355893
2025-11-28,forecast,1823205.7216311756
2025-11-29,forecast,1820065.0914373654
2025-11-30,forecast,1782098.5820287508
2025-12-01,forecast,1814348.9275884721
2025-12-02,forecast,1820050.2515702976
2025-12-03,forecast,1811453.825473292
2025-12-04,forecast,1811490.0314640498
2025-12-05,forecast,1809202.767382487
2025-12-06,forecast,1771301.4589776758
2025-12-07,forecast,1772356.7499273713
2025-12-08,forecast,1781022.9104226336
2025-12-09,forecast,1763478.0963712286
2025-12-10,forecast,1772164.2428041385
2025-12-11,forecast,1764973.7476563393
2025-12-12,forecast,1765073.3210670007
2025-12-13,forecast,1752748.1727762832
2025-12-14,forecast,1718999.9950082623
2025-12-15,forecast,1742582.11189974
2025-12-16,forecast,1737619.7272139047
2025-12-17,forecast,1730809.5828680084
2025-12-18,forecast,1720721.4717763425
2025-12-19,forecast,1705508.9656455978
2025-12-20,forecast,1697223.6979148332
2025-12-21,forecast,1686872.1294667707
2025-12-22,forecast,1713832.0290833616
2025-12-23,forecast,1712238.031200299
2025-12-24,forecast,1711975.6138528548
2025-12-25,forecast,1693598.9816102893
2025-12-26,forecast,1698327.2142652413
2025-12-27,forecast,1665680.3411902818
2025-12-28,forecast,1669208.6954435927
2025-12-29,forecast,1666137.2741070525
2025-12-30,forecast,1665027.0232585543
2025-12-31,forecast,1681445.7274510576
2026-01-01,forecast,1669477.568328362""",
    ("US", "win10", False, 0.5): """target_date,source,value
2025-10-01,actual,2179007.0
2025-10-02,actual,2123179.0
2025-10-03,actual,2046980.0
2025-10-04,actual,1633878.0
2025-10-05,actual,1476664.0
2025-10-06,actual,1892465.0
2025-10-07,actual,2034033.0
2025-10-08,actual,2036765.0
2025-10-09,actual,2008356.0
2025-10-10,actual,1936637.0
2025-10-11,actual,1576761.0
2025-10-12,actual,1453070.0
2025-10-13,actual,1842382.0
2025-10-14,actual,1999275.0
2025-10-15,actual,2025998.0
2025-10-16,actual,1970670.0
2025-10-17,actual,1880620.0
2025-10-18,actual,1524806.0
2025-10-19,actual,1414281.0
2025-10-20,actual,1841804.0
2025-10-21,actual,1945590.0
2025-10-22,actual,1937438.0
2025-10-23,actual,1902372.0
2025-10-24,actual,1837775.0
2025-10-25,actual,1508087.0
2025-10-26,actual,1392384.0
2025-10-27,actual,1801666.0
2025-10-28,actual,1924953.0
2025-10-29,actual,1937731.0
2025-10-30,actual,1914020.0
2025-10-31,actual,1846253.0
2025-11-01,forecast,1751481.0472115255
2025-11-02,forecast,1728645.8623316186
2025-11-03,forecast,1758039.4710292532
2025-11-04,forecast,1734839.2708249255
2025-11-05,forecast,1752209.613766449
2025-11-06,forecast,1733392.096885981
2025-11-07,forecast,1731057.7735036411
2025-11-08,forecast,1710013.2309295228
2025-11-09,forecast,1716670.5038275816
2025-11-10,forecast,1718820.4573251123
2025-11-11,forecast,1714464.419917006
2025-11-12,forecast,1706440.169704209
2025-11-13,forecast,1701516.2426296365
2025-11-14,forecast,1703194.505494006
2025-11-15,forecast,1704844.76938714
2025-11-16,forecast,1671281.7325834325
2025-11-17,forecast,1689529.7187056416
2025-11-18,forecast,1671180.619777129
2025-11-19,forecast,1681551.5114219836
2025-11-20,forecast,1675933.134667424
2025-11-21,forecast,1669960.5968752105
2025-11-22,forecast,1640265.932216846
2025-11-23,forecast,1631914.8784904438
2025-11-24,forecast,1644951.0375109436
2025-11-25,forecast,1640345.231279194
2025-11-26,forecast,1651383.5041861692
2025-11-27,forecast,1643633.4534117382
2025-11-28,forecast,1626265.1179234928
2025-11-29,forecast,1624915.2739996864
2025-11-30,forecast,1590747.5518253697
2025-12-01,forecast,1619502.54733621
2025-12-02,forecast,1624968.3067784149
2025-12-03,forecast,1617495.712658701
2025-12-04,forecast,1617606.5742566749
2025-12-05,forecast,1615856.9191566333
2025-12-06,forecast,1583243.7536162706
2025-12-07,forecast,1583884.673434665
2025-12-08,forecast,1591388.1887883437
2025-12-09,forecast,1575904.86901305
2025-12-10,forecast,1583779.5797497798
2025-12-11,forecast,1577306.9337264525
2025-12-12,forecast,1577578.6865800144
2025-12-13,forecast,1567738.897524275
2025-12-14,forecast,1537115.0538423564
2025-12-15,forecast,1557852.5882746219
2025-12-16,forecast,1553527.3895526093
2025-12-17,forecast,1547422.8747808514
2025-12-18,forecast,1538264.634136485
2025-12-19,forecast,1524734.3686972244
2025-12-20,forecast,1518419.288178227
2025-12-21,forecast,1508642.2793184663
2025-12-22,forecast,1532313.9632395622
2025-12-23,forecast,1530919.0166886419
2025-12-24,forecast,1530596.7150247467
2025-12-25,forecast,1513936.193607125
2025-12-26,forecast,1518174.3198468194
2025-12-27,forecast,1489981.169952881
2025-12-28,forecast,1492556.5233680885
2025-12-29,forecast,1489280.1294070757
2025-12-30,forecast,1488259.9301259357
2025-12-31,forecast,1502796.2600897704
2026-01-01,forecast,1491799.1989366426""",
    ("US", "win10", True, 0.2): """target_date,source,value
2025-10-28,actual,1826710.5714285714
2025-10-29,actual,1818093.5714285714
2025-10-30,actual,1810623.607142857
2025-10-31,actual,1803454.7857142857
2025-11-01,forecast,1801665.070286028
2025-11-02,forecast,1804665.9626857904
2025-11-03,forecast,1793422.7930159492
2025-11-04,forecast,1776671.9527483669
2025-11-05,forecast,1760077.6065585115
2025-11-06,forecast,1744007.215923306
2025-11-07,forecast,1731019.9344084382
2025-11-08,forecast,1729824.0093147259
2025-11-09,forecast,1732899.509516978
2025-11-10,forecast,1721731.637409459
2025-11-11,forecast,1705640.8522023016
2025-11-12,forecast,1688307.0599396655
2025-11-13,forecast,1672301.4150807394
2025-11-14,forecast,1660166.0637817923
2025-11-15,forecast,1660206.5852088376
2025-11-16,forecast,1663446.779620434
2025-11-17,forecast,1652164.0497418127
2025-11-18,forecast,1636416.1640865079
2025-11-19,forecast,1621399.1603632697
2025-11-20,forecast,1607310.1826274996
2025-11-21,forecast,1595092.231334331
2025-11-22,forecast,1593891.2852118402
2025-11-23,forecast,1596165.8229145024
2025-11-24,forecast,1584600.0168918276
2025-11-25,forecast,1568482.3075160116
2025-11-26,forecast,1552172.4656881227
2025-11-27,forecast,1536066.7271608224
2025-11-28,forecast,1522431.5044775126
2025-11-29,forecast,1517212.6862458237
2025-11-30,forecast,1512907.448270094
2025-12-01,forecast,1508361.3236226607
2025-12-02,forecast,1504037.6012109688
2025-12-03,forecast,1499226.3593308553
2025-12-04,forecast,1495009.307451823
2025-12-05,forecast,1490167.0442544806
2025-12-06,forecast,1485681.6108703979
2025-12-07,forecast,1481234.421828029
2025-12-08,forecast,1477054.8264478163
2025-12-09,forecast,1472008.9828337128
2025-12-10,forecast,1467109.3783174541
2025-12-11,forecast,1463180.1771701782
2025-12-12,forecast,1458775.8337913237
2025-12-13,forecast,1453861.6200596294
2025-12-14,forecast,1449191.0969721822
2025-12-15,forecast,1443801.1881013953
2025-12-16,forecast,1439773.589326156
2025-12-17,forecast,1434831.764283598
2025-12-18,forecast,1430156.7486249616
2025-12-19,forecast,1425625.5809732596
2025-12-20,forecast,1421274.940060369
2025-12-21,forecast,1416908.2206852413
2025-12-22,forecast,1412817.4645190372
2025-12-23,forecast,1408912.0466088015
2025-12-24,forecast,1404032.1981414298
2025-12-25,forecast,1400053.2462192697
2025-12-26,forecast,1395971.0573234202
2025-12-27,forecast,1392135.8046896905
2025-12-28,forecast,1387917.3408584725
2025-12-29,forecast,1383451.3202417234
2025-12-30,forecast,1379297.7634336813
2025-12-31,forecast,1375051.45797405
2026-01-01,forecast,1370497.5667350632""",

}

@pytest.mark.parametrize(
    "country,population,ma,quantile",
    [
        (None, None, False, 0.5),
        ("US", None, False, 0.5),
        (None, "win10", False, 0.5),
        ("US", "win10", False, 0.5),
        ("US", "win10", True, 0.2),
    ],
)
def test_to_forecast_df(
    cur_mozaic: Mozaic,
    country: str,
    population: str,
    ma: bool,
    quantile: float,
):
    # Actual
    assert_columns_matchactual = cur_mozaic.to_forecast_df(country=country, population=population, ma=ma, quantile=quantile)
    assert_columns_match(assert_columns_matchactual, ["target_date", "source", "value"])
    assert_dataframes_equal(
        assert_columns_matchactual, 
        pd.read_csv(
            StringIO(G_FORECAST_DATA_DF[(country, population, ma, quantile)]),
            dtype={'source': 'str','value': 'float'},
            parse_dates=['target_date']
            )
        )

## _add_indicator_column

INDICATOR_INPUT_DF = """target_date,source,value
2025-10-01,actual,9705742.0
2025-10-02,actual,9505331.0
2025-10-03,actual,9186899.0
2025-10-04,actual,7199167.0
2025-10-05,actual,6604670.0"""

G_INDICATOR_OUTPUT_DF = """target_date,country,population,source,value
2025-10-01,US,win10,actual,9705742.0
2025-10-02,US,win10,actual,9505331.0
2025-10-03,US,win10,actual,9186899.0
2025-10-04,US,win10,actual,7199167.0
2025-10-05,US,win10,actual,6604670.0
"""

def test__add_indicator_columns(cur_mozaic: Mozaic):
    actual = Mozaic._add_indicator_columns('US', 'win10',
        pd.read_csv(StringIO(INDICATOR_INPUT_DF), parse_dates=['target_date'])
        )
    expected = pd.read_csv(StringIO(G_INDICATOR_OUTPUT_DF), parse_dates=['target_date'])

    assert_columns_match(actual, ["target_date", "country", "population", "source", "value"])
    assert_dataframes_equal(actual, expected)


## to_granular_forecast_df

G_GRANULAR_FORECAST_DF_ABBREV_HEAD = """
target_date,country,population,source,value
2025-10-01,JP,None,actual,1266666.0
2025-10-01,JP,other,actual,169942.0
2025-10-01,JP,win10,actual,324210.0
2025-10-01,JP,win11,actual,733024.0
2025-10-01,JP,winX,actual,39490.0
2025-10-01,None,None,actual,9705742.0
2025-10-01,None,other,actual,1979205.0
2025-10-01,None,win10,actual,2503217.0
2025-10-01,None,win11,actual,4967798.0
2025-10-01,None,winX,actual,255522.0
"""


G_GRANULAR_FORECAST_DF_ABBREV_TAIL = """
target_date,country,population,source,value
2026-01-01,None,None,forecast,8250109.124906215
2026-01-01,None,other,forecast,1719416.559299388
2026-01-01,None,win10,forecast,1669477.568328362
2026-01-01,None,win11,forecast,4620945.984632596
2026-01-01,None,winX,forecast,240269.01264586757
2026-01-01,US,None,forecast,7023569.5419397885
2026-01-01,US,other,forecast,1572620.0490399334
2026-01-01,US,win10,forecast,1491799.1989366426
2026-01-01,US,win11,forecast,3754648.806555793
2026-01-01,US,winX,forecast,204501.4874074192
"""

def test_to_granular_forecast_df(cur_mozaic: Mozaic):
    actual = cur_mozaic.to_granular_forecast_df(ma=False, quantile=0.5)
    assert_columns_match(actual, ["target_date", "country", "population", "source", "value"])

    # Original table is too big for direct comparison
    assert actual.shape == (1395,5), f'actual.size = {actual.shape}'
    assert_dataframes_equal(
        actual.head(10),
        pd.read_csv(StringIO(G_GRANULAR_FORECAST_DF_ABBREV_HEAD), parse_dates=['target_date'], keep_default_na=False)
        )
    assert_dataframes_equal(
        actual.tail(10).reset_index(drop=True),
        pd.read_csv(StringIO(G_GRANULAR_FORECAST_DF_ABBREV_TAIL), parse_dates=['target_date'], keep_default_na=False)
        )